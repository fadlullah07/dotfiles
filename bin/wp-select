#!/bin/bash

# --- SHARED CONFIGURATION ---
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
STATE_FILE="/tmp/hypr-wallpaper-state"
CONF_FILE="$HOME/.config/hypr/hyprpaper.conf" # <--- Added config path

# --- SCRIPT LOGIC ---

# Get a sorted list of all image files.
WALLPAPERS=()
while IFS= read -r -d $'\0' file; do
  WALLPAPERS+=("$file")
done < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" \) -print0 | sort -z)

# Check if any image files were found
if [ ${#WALLPAPERS[@]} -eq 0 ]; then
  notify-send "No image files found" "Please check your WALLPAPER_DIR configuration."
  exit 1
fi

# Use walker to select a wallpaper
# Note: Ensure walker is installed and configured correctly
SELECTED_WALLPAPER=$(printf "%s\n" "${WALLPAPERS[@]}" | walker --dmenu -N -H -p "Choose Wallpaper")

# Exit if the user cancelled
if [ -z "$SELECTED_WALLPAPER" ]; then
  exit 0
fi

# -----------------------------------------------------
# 1. PERMANENT CONFIG CHANGE (NEW SECTION)
# -----------------------------------------------------
# This ensures the wallpaper persists after reboot.

# Create the config file if it doesn't exist
if [ ! -f "$CONF_FILE" ]; then
  touch "$CONF_FILE"
fi

# Create a temp file excluding old 'preload' and 'wallpaper' lines
# We use grep -v to keep everything EXCEPT the wallpaper settings
grep -vE "^preload|^wallpaper" "$CONF_FILE" >"$CONF_FILE.tmp"

# Append the new settings to the temp file
echo "preload = $SELECTED_WALLPAPER" >>"$CONF_FILE.tmp"
echo "wallpaper = ,$SELECTED_WALLPAPER" >>"$CONF_FILE.tmp"

# Overwrite the original config with the new one
mv "$CONF_FILE.tmp" "$CONF_FILE"

# -----------------------------------------------------
# 2. LIVE SESSION UPDATE
# -----------------------------------------------------

# Check if hyprpaper is running, if not, launch it
if ! pgrep -x hyprpaper &>/dev/null; then
  hyprpaper &
  sleep 1
fi

# Preload the new wallpaper
hyprctl hyprpaper preload "$SELECTED_WALLPAPER"

# Apply the wallpaper (comma means all monitors)
hyprctl hyprpaper wallpaper ",$SELECTED_WALLPAPER"

# Unload old wallpapers to free RAM (Hyprpaper keeps the active one)
hyprctl hyprpaper unload all

# --- SYNCHRONIZATION LOGIC ---
# Find the index of the selected wallpaper in our sorted list.
for i in "${!WALLPAPERS[@]}"; do
  if [[ "${WALLPAPERS[$i]}" == "$SELECTED_WALLPAPER" ]]; then
    echo "$i" >"$STATE_FILE"
    break
  fi
done

# Optional: Notification
notify-send "Wallpaper Updated" "Set to $(basename "$SELECTED_WALLPAPER") and saved to config."
